---
- hosts: localhost
  tasks:
      - name: Download IUS Repository Installer
        get_url:
            url: https://setup.ius.io
            dest: /tmp/ius.sh

      - name: Install IUS Repository
        shell: bash /tmp/ius.sh
        args:
            creates: /etc/yum.repos.d/ius.repo

      - name: Download Haskell Stack Installer
        get_url:
            url: https://get.haskellstack.org
            dest: /tmp/stack.sh

      - name: Install Haskell Stack
        shell: bash /tmp/stack.sh
        args:
            creates: /usr/local/bin/stack

      - name: Install Packages
        yum:
            name: "{{ item }}"
        with_items:
            - git2u
            - python36u
            - python36u-pip
            - neovim

      - name: Install Python2 Packages
        pip:
            name: "{{ item }}"
            executable: pip2.7
        with_items:
            - neovim
            - jedi
            - flake8
            - icdiff
            - Pygments
            - virtualenvwrapper

      - name: Install Python3 Packages
        pip:
            name: "{{ item }}"
            executable: pip3.6
        with_items:
            - neovim
            - jedi
            - flake8
            - icdiff
            - Pygments
            - virtualenvwrapper

      - name: Create Symbolic Links
        file:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            state: link
        with_items:
            - { src: "{{ lookup('pipe', 'which python3.6') }}", dest: '/usr/local/bin/python3' }
            - { src: "{{ lookup('pipe', 'which pip3.6') }}", dest: '/usr/local/bin/pip3' }

      - name: Set Alternative Commands
        alternatives:
            name: "{{ item.name }}"
            link: "{{ item.link }}"
            path: "{{ item.path }}"
            priority: "{{ item.priority }}"
        with_items:
            - { name: 'python', link: '/usr/local/bin/python', path: "{{ lookup('pipe', 'which python2') }}", priority: 20 }
            - { name: 'python', link: '/usr/local/bin/python', path: "{{ lookup('pipe', 'which python3') }}", priority: 30 }
            - { name: 'pip', link: '/usr/local/bin/pip', path: "{{ lookup('pipe', 'which pip2') }}", priority: 20 }
            - { name: 'pip', link: '/usr/local/bin/pip', path: "{{ lookup('pipe', 'which pip3') }}", priority: 30 }
            - { name: 'vi', link: '/usr/local/bin/vi', path: "{{ lookup('pipe', 'which nvim') }}", priority: 100 }

      - name: Create Config Directory
        file:
            path: ~/.config
            state: directory

      - name: Clone Dotfiles Repository
        git:
            repo: https://github.com/IMOKURI/dotfiles.git
            dest: ~/.dotfiles

      - name: Create Symbolic Links To Dotfiles
        make:
            chdir: ~/.dotfiles
            target: deploy

      - name: Setup Virtualenv Dir
        shell: source /usr/bin/virtualenvwrapper.sh
        environment:
            WORKON_HOME: ~/.virtualenvs

      - name: Setup Virtualenv Default Package Dir
        file:
            path: "{{ item }}"
            state: directory
        with_items:
            - ~/.virtualenvs/deps
            - ~/.virtualenvs/deps3

      - name: Install Virtualenv Default Package for Python2
        pip:
            name: "{{ item }}"
            executable: pip2.7
            extra_args: --target ~/.virtualenvs/deps
        with_items:
            - neovim
            - jedi
            - flake8

      - name: Install Virtualenv Default Package for Python3
        pip:
            name: "{{ item }}"
            executable: pip3.6
            extra_args: --target ~/.virtualenvs/deps3
        with_items:
            - neovim
            - jedi
            - flake8

      - name: Setup Virtualenv Boot Script
        blockinfile:
            path: ~/.virtualenvs/postmkvirtualenv 
            block: |
                # find directory
                SITEDIR=\$(virtualenvwrapper_get_site_packages_dir)
                PYVER=\$(virtualenvwrapper_get_python_version)

                # create new .pth file with our path depending of python version
                if [[ \$PYVER == 3* ]];
                then
                    echo "\$HOME/.virtualenvs/deps3/" > "\$SITEDIR/extra.pth";
                else
                    echo "\$HOME/.virtualenvs/deps/" > "\$SITEDIR/extra.pth";
                fi
