#!/usr/bin/env bash

set -eu -o pipefail

export DOTFILES_REPO="https://github.com/IMOKURI/dotfiles.git"
export DOTPATH=~/.dotfiles

function speak(){
  echo "========== $(date -u '+%Y-%m-%d_%H:%M:%S') $1 =========="
}

function set_proxy(){
  speak "Setting Proxy..."

  export http_proxy="$1"
  export https_proxy="$1"

  echo "proxy = \"$1\"" > ~/.curlrc

  echo "http_proxy=$1" > ~/.wgetrc
  echo "https_proxy=$1" >> ~/.wgetrc

  echo "export http_proxy=$1" > ~/.bash_profile.local
  echo "export https_proxy=$1" >> ~/.bash_profile.local
}

speak "Starting..."

while true; do
  read -r -p "Do you wish to use proxy to download dotfiles? " -e yn
  case $yn in
    [Yy]* )
      read -r -p "Please input proxy address and port(ex: http://proxy.example.com:8080). " proxy_uri
      set_proxy "$proxy_uri"
      break;;
    [Nn]* )
      break;;
    * )
      echo "Please answer yes or no.";;
  esac
done

speak "Install IUS Repository..."

bash -c "$(curl -fsSL https://setup.ius.io)"

speak "Install Packages..."

yum install -y git2u python36u python36u-pip python python-setuptools neovim

speak "Install Haskell Stack..."

bash -c "$(curl -fsSL https://get.haskellstack.org)"

speak "Install Python2 Packages(Global)..."

easy_install-2.7 pip

pip2 install neovim jedi flake8 icdiff Pygments virtualenvwrapper

speak "Install Python3 Packages(Global)..."

cd /usr/bin

ln -s python3.6 python3
ln -s pip3.6 pip3

pip3 install neovim jedi flake8 icdiff Pygments virtualenvwrapper

speak "Downloading dotfiles..."

git clone --recursive "$DOTFILES_REPO" "$DOTPATH"

speak "Deploying dotfiles..."

cd ~/.dotfiles
mkdir ~/.config

make deploy

speak "Setup alternative commands..."

update-alternatives --install /usr/local/bin/python python "$(which python2)" 20
update-alternatives --install /usr/local/bin/python python "$(which python3)" 30

update-alternatives --install /usr/local/bin/pip pip "$(which pip2)" 20
update-alternatives --install /usr/local/bin/pip pip "$(which pip3)" 30

update-alternatives --install /usr/local/bin/vi vi "$(which nvim)" 100

speak "Source dotfiles..."

source ~/.bash_profile
source ~/.bashrc

speak "Install Python Packages(For Virtualenv)"

mkdir -p ~/.virtualenvs/deps
mkdir -p ~/.virtualenvs/deps3

pip2 install -U --target ~/.virtualenvs/deps neovim jedi flake8
pip3 install -U --target ~/.virtualenvs/deps3 neovim jedi flake8

speak "Setup Virtualenv Boot Script"

cat << EOS >> ~/.virtualenvs/postmkvirtualenv
# find directory
SITEDIR=$(virtualenvwrapper_get_site_packages_dir)
PYVER=$(virtualenvwrapper_get_python_version)

# create new .pth file with our path depending of python version
if [[ $PYVER == 3* ]];
then
    echo "$HOME/.virtualenvs/deps3/" > "$SITEDIR/extra.pth";
else
    echo "$HOME/.virtualenvs/deps/" > "$SITEDIR/extra.pth";
fi
EOS

speak "Finished!"
