#!/usr/bin/env bash

set -eu -o pipefail

export DOTFILES_REPO="https://github.com/IMOKURI/dotfiles.git"
export DOTPATH=~/.dotfiles

function speak(){
  echo "-----> $(date -u '+%Y-%m-%d_%H:%M:%S') $1"
}

function is_exist(){
  type "$1" >/dev/null 2>&1
  return $?
}

function set_proxy(){
  speak "Setting Proxy..."

  export http_proxy="$1"
  export https_proxy="$1"

  echo "proxy = \"$1\"" > ~/.curlrc

  echo "http_proxy=$1" > ~/.wgetrc
  echo "https_proxy=$1" >> ~/.wgetrc

  echo "export http_proxy=$1" > ~/.bash_profile.local
  echo "export https_proxy=$1" >> ~/.bash_profile.local
}

speak "Starting..."

while true; do
  read -r -p "Do you wish to use proxy to download dotfiles? " -e yn
  case $yn in
    [Yy]* )
      read -r -p "Please input proxy address and port(ex: http://proxy.example.com:8080). " proxy_uri
      set_proxy "$proxy_uri"
      break;;
    [Nn]* )
      break;;
    * )
      echo "Please answer yes or no.";;
  esac
done

speak "Downloading dotfiles..."

if is_exist "git"; then
  git clone --recursive "$DOTFILES_REPO" "$DOTPATH"
else
  echo "Need to install git for installation."
  exit 1
fi

if cd ~/.dotfiles; then
  exit 1
fi

speak "Deploying dotfiles..."

make deploy

speak "Finished!"
